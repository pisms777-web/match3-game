<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <title>3 в ряд — v2.0</title>
  <!-- PWA -->
  <meta name="theme-color" content="#e91e63">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://placehold.co/180x180/e91e63/white?text=3вРяд">
  <link rel="manifest" href="application/manifest+json,{
    %22name%22:%223%20в%20ряд%22,
    %22short_name%22:%223вРяд%22,
    %22start_url%22:%22./%22,
    %22display%22:%22standalone%22,
    %22background_color%22:%22%23f0f0f0%22,
    %22theme_color%22:%22%23e91e63%22,
    %22icons%22:[{
      %22src%22:%22https://placehold.co/192x192/e91e63/white?text=3вРяд%22,
      %22sizes%22:%22192x192%22,
      %22type%22:%22image/png%22
    }]
  }">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 8px 8px 12px;
      background: #f0f0f0;
      font-family: sans-serif;
      overflow: hidden;
      touch-action: none;
    }
    body.dark { background: #1e1e1e; }
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    #score-container { text-align: center; flex: 1; }
    #score, #level, #goal, #high-score {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }
    body.dark #score,
    body.dark #level,
    body.dark #goal,
    body.dark #high-score {
      color: #f0f0f0;
    }
    #settings-btn {
      background: #2196f3;
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
    }
    #game {
      position: relative;
      display: grid;
      grid-template-columns: repeat(10, 8.8vw);
      grid-template-rows: repeat(10, 8.8vw);
      gap: 2px;
      background: #333;
      padding: 6px;
      border-radius: 10px;
      margin: 0 auto;
      max-width: 96vw;
    }
    .cell {
      border-radius: 6px;
    }
    body.round .cell {
      border-radius: 50%;
    }
    #dragging-clone {
      position: absolute;
      pointer-events: none;
      z-index: 100;
      transform: translate(-50%, -50%);
    }
    body.round #dragging-clone {
      border-radius: 50%;
    }
    .particle {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 200;
      opacity: 1;
    }
    @keyframes fall {
      from { transform: translateY(-100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    #notification {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    #notification-content {
      background: white;
      padding: 24px;
      border-radius: 12px;
      text-align: center;
      max-width: 80%;
    }
    body.dark #notification-content { background: #2a2a2a; color: white; }
    #notification-content button {
      padding: 10px 20px;
      background: #2196f3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="header">
    <div id="score-container">
      <div id="score">Счёт: 0</div>
      <div id="level">Уровень: 1</div>
      <div id="goal">Цель: 500</div>
      <div id="high-score">Рекорд: 0</div>
    </div>
    <button id="settings-btn">⚙️</button>
  </div>
  <div id="game"></div>
  <div id="notification">
    <div id="notification-content">
      <h2 id="notification-text">Уровень пройден!</h2>
      <button id="next-level-btn">Далее</button>
    </div>
  </div>

  <!-- Настройки (скрыты по умолчанию) -->
  <div id="settings" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; width:80%; max-width:300px;">
      <h3>Настройки</h3>
      <label>Фон: 
        <select id="theme-select">
          <option value="light">Светлый</option>
          <option value="dark">Тёмный</option>
        </select>
      </label><br><br>
      <label>Форма: 
        <select id="shape-select">
          <option value="square">Квадраты</option>
          <option value="round">Круги</option>
        </select>
      </label><br><br>
      <button onclick="document.getElementById('settings').style.display='none'">Закрыть</button>
    </div>
  </div>

  <!-- Подключаем ядро -->
  <script src="game-core.js"></script>
  <script>
    // === НАСТРОЙКИ ===
    let theme = localStorage.getItem('match3Theme') || 'light';
    let shape = localStorage.getItem('match3Shape') || 'square';
    document.body.classList.toggle('dark', theme === 'dark');
    document.body.classList.toggle('round', shape === 'round');
    document.getElementById('theme-select').value = theme;
    document.getElementById('shape-select').value = shape;

    // === УРОВНИ ===
    const LEVEL_GOALS = [500, 800, 1200, 1600, 2000, 2500];
    let currentLevel = 1;
    let score = 0;
    let highScore = localStorage.getItem('match3HighScore') ? parseInt(localStorage.getItem('match3HighScore')) : 0;

    // === ИНИЦИАЛИЗАЦИЯ ЯДРА ===
    const game = new GameCore({
      onScoreChange: (points) => {
        score += points;
        document.getElementById('score').textContent = `Счёт: ${score}`;
        if (score > highScore) {
          highScore = score;
          localStorage.setItem('match3HighScore', highScore);
          document.getElementById('high-score').textContent = `Рекорд: ${highScore}`;
        }
      },
      onBoardUpdate: (board) => {
        // ничего не делаем — рендер в ядре
      },
      onSwapAttempt: (r1, c1, r2, c2) => {
        // временная доска для проверки
        const tempBoard = JSON.parse(JSON.stringify(game.board));
        [tempBoard[r1][c1], tempBoard[r2][c2]] = [tempBoard[r2][c2], tempBoard[r1][c1]];
        const matches = new Set();
        // Проверка совпадений (повторяем логику из ядра)
        for (let r = 0; r < 10; r++) {
          for (let c = 0; c <= 7; c++) {
            const col = tempBoard[r][c];
            if (col && tempBoard[r][c+1] === col && tempBoard[r][c+2] === col) {
              let k = c; while (k < 10 && tempBoard[r][k] === col) { matches.add(`${r},${k}`); k++; }
            }
          }
        }
        for (let c = 0; c < 10; c++) {
          for (let r = 0; r <= 7; r++) {
            const col = tempBoard[r][c];
            if (col && tempBoard[r+1][c] === col && tempBoard[r+2][c] === col) {
              let k = r; while (k < 10 && tempBoard[k][c] === col) { matches.add(`${k},${c}`); k++; }
            }
          }
        }
        if (matches.size === 0) {
          game.renderBoard(); // откат
        } else {
          [game.board[r1][c1], game.board[r2][c2]] = [game.board[r2][c2], game.board[r1][c1]];
          game.renderBoard();
          setTimeout(() => {
            game.removeMatchesAndRefill(matches, (pts) => {
              score += pts;
              document.getElementById('score').textContent = `Счёт: ${score}`;
              if (score > highScore) {
                highScore = score;
                localStorage.setItem('match3HighScore', highScore);
                document.getElementById('high-score').textContent = `Рекорд: ${highScore}`;
              }
              // Проверка цели
              const goal = LEVEL_GOALS[currentLevel - 1];
              if (score >= goal) {
                if (currentLevel < LEVEL_GOALS.length) {
                  showNotification(`Уровень ${currentLevel} пройден!`, () => {
                    currentLevel++;
                    startLevel(currentLevel);
                  });
                } else {
                  showNotification('Все уровни пройдены!', () => startLevel(1));
                }
              }
            });
          }, 300);
        }
      }
    });

    function startLevel(level) {
      currentLevel = level;
      score = 0;
      document.getElementById('score').textContent = `Счёт: ${score}`;
      document.getElementById('level').textContent = `Уровень: ${level}`;
      document.getElementById('goal').textContent = `Цель: ${LEVEL_GOALS[level - 1]}`;
      game.resetBoard();
    }

    function showNotification(text, callback) {
      document.getElementById('notification-text').textContent = text;
      document.getElementById('notification').style.display = 'flex';
      document.getElementById('next-level-btn').onclick = () => {
        document.getElementById('notification').style.display = 'none';
        callback();
      };
    }

    // === TOUCH ===
    document.addEventListener('touchstart', e => {
      if (document.getElementById('notification').style.display === 'flex' || 
          document.getElementById('settings').style.display === 'block') return;
      if (e.touches.length !== 1) return;
      game.handleTouchStart(e.touches[0].clientX, e.touches[0].clientY);
      e.preventDefault();
    }, { passive: false });

    document.addEventListener('touchmove', e => {
      if (document.getElementById('notification').style.display === 'flex' || 
          document.getElementById('settings').style.display === 'block') return;
      if (e.touches.length !== 1) return;
      game.handleTouchMove(e.touches[0].clientX, e.touches[0].clientY);
      e.preventDefault();
    }, { passive: false });

    document.addEventListener('touchend', e => {
      if (document.getElementById('notification').style.display === 'flex' || 
          document.getElementById('settings').style.display === 'block') return;
      if (e.changedTouches.length === 0) return;
      game.handleTouchEnd(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
    }, { passive: false });

    // === НАСТРОЙКИ ===
    document.getElementById('settings-btn').onclick = () => {
      document.getElementById('settings').style.display = 'flex';
    };

    document.getElementById('theme-select').onchange = (e) => {
      theme = e.target.value;
      localStorage.setItem('match3Theme', theme);
      document.body.classList.toggle('dark', theme === 'dark');
    };

    document.getElementById('shape-select').onchange = (e) => {
      shape = e.target.value;
      localStorage.setItem('match3Shape', shape);
      document.body.classList.toggle('round', shape === 'round');
    };

    // === СТАРТ ===
    window.addEventListener('load', () => {
      document.getElementById('high-score').textContent = `Рекорд: ${highScore}`;
      startLevel(1);
    });
  </script>
</body>
</html>
